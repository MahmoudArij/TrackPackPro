<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TrackPack Premium — Suivi de Colis</title>

<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

<style>
  :root{
    --bg:#071027;
    --card:#0b1220;
    --muted:#9aa6b2;
    --accent:#3b82f6;
    --accent-2:#06b6d4;
    --accent-3:#22c55e;
    --white:#e6eef8;
    --glass: rgba(255,255,255,0.03);
    --glass-border: rgba(255,255,255,0.04);
    --radius:14px;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;background:linear-gradient(180deg,#071029 0%, #071827 100%);color:var(--white);-webkit-font-smoothing:antialiased}
  .wrap{max-width:1150px;margin:28px auto;padding:20px}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:18px;border-radius:12px;background:linear-gradient(90deg, rgba(255,255,255,0.02), transparent);border:1px solid var(--glass-border);backdrop-filter: blur(6px);box-shadow:0 6px 24px rgba(2,6,23,0.6)}
  .brand{display:flex;align-items:center;gap:12px}
  .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-weight:800;color:#04263b;font-size:18px}
  .brand h1{font-size:16px;margin:0}
  .brand small{display:block;color:var(--muted);font-size:12px}
  .controls{display:flex;align-items:center;gap:10px}
  .lang-select{background:var(--glass);border:1px solid var(--glass-border);padding:6px 10px;border-radius:8px;color:var(--white);display:flex;align-items:center;gap:8px;font-weight:600}
  .lang-select select{background:transparent;border:none;color:var(--white);outline:none;font-weight:600}
  .hero{margin-top:22px;background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);padding:36px;border-radius:16px;border:1px solid var(--glass-border);box-shadow:0 6px 24px rgba(2,6,23,0.6);display:grid;grid-template-columns:1fr 420px;gap:28px;align-items:center}
  .hero-left .tag{display:inline-block;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.03);color:var(--muted);font-size:13px;margin-bottom:16px}
  .hero-left h2{font-size:28px;margin:8px 0 12px;color:var(--white);line-height:1.05}
  .hero-left p{margin:0;color:var(--muted);max-width:680px}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:18px;border:1px solid var(--glass-border)}
  form.tracking{display:flex;flex-direction:column;gap:12px}
  .inputs{display:flex;gap:10px}
  .inputs input, .inputs select{flex:1;padding:12px 14px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background: rgba(2,6,23,0.4);color:var(--white);outline:none;font-size:15px}
  .inputs select{max-width:220px}
  .actions{display:flex;gap:10px;align-items:center}
  button.primary{flex:1;background:linear-gradient(90deg,var(--accent),var(--accent-2));border:none;padding:12px;border-radius:10px;color:#04263b;font-weight:700;cursor:pointer;font-size:15px;box-shadow:0 8px 30px rgba(59,130,246,0.12)}
  button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.05);color:var(--white);padding:10px 12px;border-radius:10px;cursor:pointer}
  .hint{font-size:13px;color:var(--muted);margin-top:6px}
  .results{margin-top:20px;display:flex;flex-direction:column;gap:14px}
  .summary{display:flex;align-items:center;gap:12px;padding:12px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.015), transparent);border:1px solid var(--glass-border)}
  .logo-mini{width:48px;height:48px;border-radius:8px;background:rgba(255,255,255,0.03);display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--white)}
  .meta h3{margin:0;font-size:16px}
  .meta p{margin:2px 0 0;font-size:13px;color:var(--muted)}
  .timeline{display:flex;flex-direction:column;gap:10px;padding:8px}
  .step{display:flex;gap:12px;align-items:flex-start;padding:12px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));border:1px solid var(--glass-border);transition:transform .22s ease, box-shadow .22s ease}
  .step:hover{transform:translateY(-6px);box-shadow:0 12px 30px rgba(2,6,23,0.6)}
  .dot{min-width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-weight:800;color:#04263b}
  .step .body{flex:1}
  .step .body .time{font-size:13px;color:var(--muted)}
  .step .body .txt{font-weight:700;margin-top:4px;color:var(--white)}
  .empty{padding:26px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);border:1px dashed rgba(255,255,255,0.03);text-align:center;color:var(--muted)}
  .note{font-size:13px;color:var(--muted);margin-top:8px}
  @media(max-width:980px){.hero{grid-template-columns:1fr;padding:22px}.wrap{padding:12px}}
  /* right-to-left support for Arabic */
  .rtl { direction: rtl; }
  .rtl .inputs{flex-direction:row-reverse}
  .rtl .step{flex-direction:row-reverse}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">
      <div class="logo" aria-hidden="true">TP</div>
      <div>
        <h1 style="font-size:16px;margin:0">TrackPack</h1>
        <small style="font-size:12px;color:var(--muted)">Suivi universel</small>
      </div>
    </div>

    <div class="controls">
      <div class="lang-select" title="Choisir la langue">
        <i class="fa-solid fa-globe" style="opacity:.95"></i>
        <select id="langTop" aria-label="Langue">
          <option value="fr">FR</option>
          <option value="en">EN</option>
          <option value="es">ES</option>
          <option value="pt">PT</option>
          <option value="zh">中文</option>
          <option value="ar">AR</option>
          <option value="de">DE</option>
          <option value="nl">NL</option>
        </select>
      </div>
    </div>
  </header>

  <section class="hero" aria-labelledby="hero-title">
    <div class="hero-left">
      <div class="tag">Multi-transporteurs • Multilingue</div>
      <h2 id="hero-title">Suivez tous vos colis en temps réel</h2>
      <p id="hero-sub">Entrez votre numéro, choisissez un transporteur (ou auto) et obtenez l'historique en quelques secondes.</p>

      <div id="resultsWrap" class="results" aria-live="polite">
        <div class="empty" id="emptyMsg">Aucun suivi pour l'instant — essayez un numéro de test.</div>
      </div>
      <div class="note" id="corsNote">Remarque : si vous hébergez sur GitHub Pages, vous pourriez rencontrer des erreurs CORS. Si c'est le cas, utilisez un proxy serveur pour relayer les appels API (voir commentaire dans le code).</div>
    </div>

    <aside>
      <div class="card" role="region" aria-label="Formulaire de suivi">
        <form id="trackForm" class="tracking" autocomplete="off">
          <div class="inputs">
            <input id="trackNumber" name="trackNumber" placeholder="Ex : 1Z999AA10123456784" aria-label="Numéro de suivi">
            <select id="carrierSelect" aria-label="Transporteur">
              <option value="">Détection automatique</option>
              <option value="dhl">DHL</option>
              <option value="ups">UPS</option>
              <option value="fedex">FedEx</option>
              <option value="laposte">La Poste</option>
              <option value="usps">USPS</option>
              <option value="canadapost">Canada Post</option>
              <option value="royalmail">Royal Mail</option>
              <option value="skynet">Skynet</option>
              <option value="chinapost">China Post</option>
              <option value="amazon">Amazon Logistics</option>
              <option value="wishpost">WishPost</option>
              <option value="shopee">Shopee Express</option>
            </select>
          </div>

          <div class="actions">
            <button type="submit" class="primary" id="btnTrack"><i class="fa-solid fa-magnifying-glass" style="margin-right:8px"></i>Suivre</button>
            <button type="button" id="btnSample" class="ghost" title="Exemple">Exemple</button>
          </div>

          <div class="hint" id="hintText">Supporte la détection automatique des transporteurs si disponible via ton API.</div>
        </form>
      </div>
    </aside>
  </section>
</div>

<script>
/* =========================
   Translations (FR,EN,ES,PT,ZH,AR,DE,NL)
   Add or tweak strings here.
   ========================= */
const TRANSLATIONS = {
  fr: {
    heroTitle: "Suivez tous vos colis en temps réel",
    heroSub: "Entrez votre numéro, choisissez un transporteur (ou auto) et obtenez l'historique en quelques secondes.",
    follow: "Suivre",
    example: "Exemple",
    searching: "Recherche en cours…",
    noResults: "Aucun résultat trouvé.",
    enterNumber: "Veuillez saisir un numéro de suivi",
    lastUpdate: "Dernière mise à jour",
    hint: "Supporte la détection automatique des transporteurs si disponible via ton API.",
    sampleNumber: "1Z999AA10123456784",
    corsWarning: "Remarque : si vous hébergez sur GitHub Pages, vous pourriez rencontrer des erreurs CORS. Utilisez un proxy serveur si nécessaire."
  },
  en: {
    heroTitle: "Track all your packages in real time",
    heroSub: "Enter your number, choose a carrier (or auto) and get the history in seconds.",
    follow: "Track",
    example: "Sample",
    searching: "Searching…",
    noResults: "No results found.",
    enterNumber: "Please enter a tracking number",
    lastUpdate: "Last update",
    hint: "Supports automatic carrier detection if available via your API.",
    sampleNumber: "1Z999AA10123456784",
    corsWarning: "Note: GitHub Pages might block AfterShip calls due to CORS. Use a server proxy if needed."
  },
  es: {
    heroTitle: "Sigue todos tus paquetes en tiempo real",
    heroSub: "Introduce el número, elige un transportista (o auto) y obtén el historial en segundos.",
    follow: "Rastrear",
    example: "Ejemplo",
    searching: "Buscando…",
    noResults: "No se han encontrado resultados.",
    enterNumber: "Por favor introduce un número de seguimiento",
    lastUpdate: "Última actualización",
    hint: "Soporta detección automática de transportistas si tu API lo permite.",
    sampleNumber: "1Z999AA10123456784",
    corsWarning: "Nota: GitHub Pages puede bloquear llamadas a AfterShip por CORS. Usa un proxy si es necesario."
  },
  pt: {
    heroTitle: "Acompanhe todas as suas encomendas em tempo real",
    heroSub: "Insira o número, escolha um transportador (ou automático) e obtenha o histórico em segundos.",
    follow: "Rastrear",
    example: "Exemplo",
    searching: "Pesquisando…",
    noResults: "Nenhum resultado encontrado.",
    enterNumber: "Por favor insira um número de rastreamento",
    lastUpdate: "Última atualização",
    hint: "Suporta detecção automática de transportadoras se disponível via sua API.",
    sampleNumber: "1Z999AA10123456784",
    corsWarning: "Observação: o GitHub Pages pode bloquear chamadas AfterShip por CORS. Use um proxy."
  },
  zh: {
    heroTitle: "实时跟踪您的包裹",
    heroSub: "输入单号，选择承运商（或自动），即可在几秒钟内查看历史记录。",
    follow: "追踪",
    example: "示例",
    searching: "正在查询…",
    noResults: "未找到结果。",
    enterNumber: "请输入运单号",
    lastUpdate: "最后更新",
    hint: "如果 API 支持，支持承运商自动识别。",
    sampleNumber: "1Z999AA10123456784",
    corsWarning: "注意：GitHub Pages 可能因 CORS 而阻止 AfterShip 调用。请使用代理。"
  },
  ar: {
    heroTitle: "تتبع جميع طرودك في الوقت الحقيقي",
    heroSub: "أدخل رقم التتبع، اختر الناقل (أو تلقائيًا) واحصل على السجل خلال ثوانٍ.",
    follow: "تتبع",
    example: "مثال",
    searching: "جارٍ البحث…",
    noResults: "لم يتم العثور على نتائج.",
    enterNumber: "يرجى إدخال رقم التتبع",
    lastUpdate: "آخر تحديث",
    hint: "يدعم اكتشاف الناقل تلقائيًا إذا كانت API الخاصة بك تدعم ذلك.",
    sampleNumber: "1Z999AA10123456784",
    corsWarning: "ملاحظة: قد يمنع GitHub Pages طلبات AfterShip بسبب CORS. استخدم بروكسي إذا لزم الأمر."
  },
  de: {
    heroTitle: "Verfolge alle Ihre Pakete in Echtzeit",
    heroSub: "Gib deine Nummer ein, wähle einen Carrier (oder automatisch) und erhalte die Historie in Sekunden.",
    follow: "Verfolgen",
    example: "Beispiel",
    searching: "Suche…",
    noResults: "Keine Ergebnisse gefunden.",
    enterNumber: "Bitte Tracking-Nummer eingeben",
    lastUpdate: "Letzte Aktualisierung",
    hint: "Unterstützt automatische Carrier-Erkennung, falls über Ihre API verfügbar.",
    sampleNumber: "1Z999AA10123456784",
    corsWarning: "Hinweis: GitHub Pages kann AfterShip-Aufrufe wegen CORS blockieren. Verwenden Sie ggf. einen Proxy."
  },
  nl: {
    heroTitle: "Volg al uw pakketten in realtime",
    heroSub: "Voer uw nummer in, kies een vervoerder (of auto) en ontvang de geschiedenis in seconden.",
    follow: "Volgen",
    example: "Voorbeeld",
    searching: "Zoeken…",
    noResults: "Geen resultaten gevonden.",
    enterNumber: "Voer een traceernummer in",
    lastUpdate: "Laatste update",
    hint: "Ondersteunt automatische vervoerderdetectie als uw API dit ondersteunt.",
    sampleNumber: "1Z999AA10123456784",
    corsWarning: "Opmerking: GitHub Pages kan AfterShip-aanroepen blokkeren vanwege CORS. Gebruik een proxy indien nodig."
  }
};

let currentLang = 'fr';
const langTop = document.getElementById('langTop');
const resultsWrap = document.getElementById('resultsWrap');
const hintText = document.getElementById('hintText');
const corsNote = document.getElementById('corsNote');

function applyTranslations(){
  const t = TRANSLATIONS[currentLang];
  document.getElementById('hero-title').textContent = t.heroTitle;
  document.getElementById('hero-sub').textContent = t.heroSub;
  document.getElementById('btnTrack').innerHTML = `<i class="fa-solid fa-magnifying-glass" style="margin-right:8px"></i>${t.follow}`;
  document.getElementById('btnSample').textContent = t.example;
  hintText.textContent = t.hint;
  corsNote.textContent = t.corsWarning;
  // RTL handling for Arabic
  if(currentLang === 'ar'){ document.documentElement.classList.add('rtl'); document.body.classList.add('rtl'); }
  else { document.documentElement.classList.remove('rtl'); document.body.classList.remove('rtl'); }
}

langTop.addEventListener('change', e=>{
  currentLang = e.target.value;
  applyTranslations();
});
applyTranslations();

/* ========== Utility ========= */
function escapeHtml(s){ return String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
function clearResults(){ resultsWrap.innerHTML = ''; }
function showEmpty(){ clearResults(); const el=document.createElement('div'); el.className='empty'; el.textContent = TRANSLATIONS[currentLang].noResults; resultsWrap.appendChild(el); }

/* ========== AfterShip integration =========
  NOTE on CORS:
  - AfterShip API does not always include CORS headers allowing direct browser requests.
  - If you see CORS errors in browser console, create a tiny proxy on your server (Node/Cloud Function) that:
      * accepts requests from your page, calls AfterShip with your API key, and returns the result.
      * That keeps your API key secret and avoids CORS issues.
  Example proxy (Node/Express):
    app.post('/api/track', async (req,res)=>{
      const { number, carrier } = req.body;
      const body = { tracking: { tracking_number: number } };
      if(carrier) body.tracking.slug = carrier;
      const r = await fetch('https://api.aftership.com/v4/trackings', {
        method:'POST', headers:{ 'Content-Type':'application/json','aftership-api-key': process.env.AFTERSHIP_KEY }, body: JSON.stringify(body)
      });
      const json = await r.json();
      res.json(json);
    });
  Use that proxy endpoint instead of calling api.aftership.com directly from the browser.
*/

const AFTERSHIP_KEY = 'asat_025c8097d5b94afc8ee1941f817a603b'; // ta clé (déjà fournie)
const form = document.getElementById('trackForm');
const trackNumberInput = document.getElementById('trackNumber');
const carrierSelect = document.getElementById('carrierSelect');
const btnSample = document.getElementById('btnSample');
const btnTrack = document.getElementById('btnTrack');

/* Normalize AfterShip response into { carrierName, trackingNumber, events: [{time,status}] } */
async function fetchTrackingAftership(number, carrier){
  const url = 'https://api.aftership.com/v4/trackings';
  const body = { tracking: { tracking_number: number } };
  if (carrier) body.tracking.slug = carrier;

  // 1) Create tracking (if exists AfterShip returns 409, which is OK)
  const resp = await fetch(url, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'aftership-api-key': AFTERSHIP_KEY },
    body: JSON.stringify(body)
  });
  const data = await resp.json();
  // if API returns error that is not 201 or 409, throw
  if (data.meta && data.meta.code && data.meta.code !== 201 && data.meta.code !== 409) {
    throw new Error(data.meta.message || 'AfterShip error');
  }

  // 2) Get details (use slug if provided to ensure correct endpoint)
  // AfterShip detail endpoint: /v4/trackings/{slug}/{tracking_number}
  let detailUrl;
  if (data.data && data.data.tracking && data.data.tracking.slug) {
    detailUrl = `https://api.aftership.com/v4/trackings/${encodeURIComponent(data.data.tracking.slug)}/${encodeURIComponent(number)}`;
  } else if (carrier) {
    detailUrl = `https://api.aftership.com/v4/trackings/${encodeURIComponent(carrier)}/${encodeURIComponent(number)}`;
  } else {
    // If slug unknown, you can use search endpoint
    detailUrl = `https://api.aftership.com/v4/trackings/${encodeURIComponent(number)}`;
  }

  const detailResp = await fetch(detailUrl, { headers: { 'aftership-api-key': AFTERSHIP_KEY } });
  const detailData = await detailResp.json();

  // Normalize
  const tracking = detailData.data && detailData.data.tracking ? detailData.data.tracking : null;
  if (!tracking) return null;
  const carrierName = tracking.slug || carrier || tracking.title || 'Unknown';
  const trackingNumber = tracking.tracking_number || number;
  const checkpoints = tracking.checkpoints || [];

  const events = checkpoints.map(cp => ({
    time: cp.checkpoint_time || cp.updated_at || '',
    status: cp.message || cp.tag || cp.status || ''
  }));

  return { carrierName, trackingNumber, events };
}

/* Render helpers */
function renderTracking(data){
  clearResults();
  const summary = document.createElement('div');
  summary.className = 'summary';
  summary.innerHTML = `<div class="logo-mini">${escapeHtml((data.carrierName||'--').slice(0,2).toUpperCase())}</div>
    <div class="meta"><h3>${escapeHtml(data.carrierName)} · ${escapeHtml(data.trackingNumber)}</h3>
    <p>${escapeHtml(TRANSLATIONS[currentLang].lastUpdate)}: ${escapeHtml(data.events[0]?.time || '')}</p></div>`;
  resultsWrap.appendChild(summary);

  const timeline = document.createElement('div'); timeline.className = 'timeline';
  // show newest first: events array is in chronological order — we want latest top
  const events = Array.isArray(data.events) ? data.events.slice().reverse() : [];
  events.forEach((ev, idx) => {
    const step = document.createElement('div'); step.className = 'step';
    step.innerHTML = `<div class="dot">${idx+1}</div>
      <div class="body"><div class="time">${escapeHtml(ev.time)}</div><div class="txt">${escapeHtml(ev.status)}</div></div>`;
    timeline.appendChild(step);
  });
  resultsWrap.appendChild(timeline);
}

/* Form logic */
form.addEventListener('submit', async function(e){
  e.preventDefault();
  const number = trackNumberInput.value.trim();
  const carrier = carrierSelect.value;
  if (!number) { alert(TRANSLATIONS[currentLang].enterNumber); return; }

  clearResults();
  const loading = document.createElement('div'); loading.className = 'summary';
  loading.innerHTML = `<div style="width:48px;height:48px;border-radius:8px;background:rgba(255,255,255,0.02);display:flex;align-items:center;justify-content:center"><i class="fa-solid fa-spinner fa-spin" style="opacity:.7"></i></div>
    <div class="meta"><h3>${escapeHtml(TRANSLATIONS[currentLang].searching)}</h3><p style="color:var(--muted)">${escapeHtml(number)}</p></div>`;
  resultsWrap.appendChild(loading);

  try {
    // Attempt direct AfterShip calls
    const data = await fetchTrackingAftership(number, carrier || '');
    if (!data || !data.events || data.events.length === 0) {
      clearResults();
      const el = document.createElement('div'); el.className = 'empty'; el.textContent = TRANSLATIONS[currentLang].noResults; resultsWrap.appendChild(el);
      return;
    }
    renderTracking(data);
  } catch (err) {
    clearResults();
    const errEl = document.createElement('div'); errEl.className = 'empty';
    // If error looks like CORS or network, instruct to use proxy
    const msg = err.message || (err.toString && err.toString()) || 'Error';
    if (msg.toLowerCase().includes('failed to fetch') || msg.toLowerCase().includes('cors')) {
      errEl.innerHTML = `<strong>${escapeHtml(TRANSLATIONS[currentLang].noResults)}</strong><br>${escapeHtml(TRANSLATIONS[currentLang].corsWarning)}<br><small style="color:var(--muted)">${escapeHtml(msg)}</small>`;
    } else {
      errEl.textContent = msg;
    }
    resultsWrap.appendChild(errEl);
    console.error(err);
  }
});

/* Sample button */
btnSample.addEventListener('click', ()=>{
  trackNumberInput.value = TRANSLATIONS[currentLang].sampleNumber;
  carrierSelect.value = '';
  trackNumberInput.focus();
});

/* Initialize */
showEmpty();
</script>
</body>
</html>
